// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String         @id @default(cuid())
  email                   String         @unique
  name                    String
  passwordHash            String
  emailVerified           Boolean        @default(false)
  verificationToken       String?        @unique
  verificationTokenExpiry DateTime?
  resetToken              String?        @unique
  resetTokenExpiry        DateTime?
  isAdmin                 Boolean        @default(false)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  subscription            Subscription?
  payments                Payment[]
  reservations            Reservation[]
  emailLogs               EmailLog[]

  @@map("users")
}

model SubscriptionPlan {
  id               String         @id @default(cuid())
  name             String
  description      String
  price            Int            // Price in CLP (e.g., 9990 = $9.990 CLP)
  interval         String         // "monthly" or "yearly"
  features         Json           // Array of feature strings
  isActive         Boolean        @default(true)
  // Per-plan penalty configuration (defaults match global constants in penalty.service.ts)
  gracePeriodDays  Int            @default(2)
  penaltyBaseRate  Float          @default(0.05)  // 5% base penalty
  penaltyDailyRate Float          @default(0.005) // +0.5% per day late
  penaltyMaxRate   Float          @default(0.5)   // 50% cap
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  subscriptions    Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                 String           @id @default(cuid())
  userId             String           @unique
  user               User             @relation(fields: [userId], references: [id])
  planId             String
  plan               SubscriptionPlan @relation(fields: [planId], references: [id])
  mercadopagoSubId   String?          @unique
  preferenceId       String?          @unique
  status             String           // active, cancelled, suspended, past_due, pending
  planPrice          Int              // Price in CLP at time of subscription
  nextBillingDate    DateTime
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  gracePeriodEnd     DateTime?
  cancelledAt        DateTime?
  metadata           Json?            // Stores scheduled plan changes and other metadata
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  payments           Payment[]

  @@map("subscriptions")
}

model WebhookEvent {
  id        String   @id @default(cuid())
  eventType String
  eventId   String   @unique
  data      Json
  processed Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("webhook_events")
}

model Payment {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  mercadopagoId  String       @unique
  amount         Int          // Base amount in CLP (whole numbers, no cents)
  penaltyFee     Int          @default(0) // Penalty fee in CLP
  totalAmount    Int          // Total amount (amount + penaltyFee) in CLP
  status         String       // pending, approved, rejected, refunded
  dueDate        DateTime
  paidAt         DateTime?
  metadata       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([userId])
  @@index([subscriptionId])
  @@index([mercadopagoId])
  @@map("payments")
}

model Resource {
  id           String                 @id @default(cuid())
  name         String
  description  String?
  type         String                 // room, equipment, service
  capacity     Int?
  isActive     Boolean                @default(true)
  metadata     Json?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  reservations Reservation[]
  availability ResourceAvailability[]

  @@map("resources")
}

model Reservation {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  resourceId  String
  resource    Resource @relation(fields: [resourceId], references: [id])
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  status      String   // pending, confirmed, cancelled, completed
  attendees   Int      @default(1)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([resourceId])
  @@index([startTime, endTime])
  @@map("reservations")
}

model ResourceAvailability {
  id         String   @id @default(cuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  dayOfWeek  Int      // 0-6 (Sunday-Saturday)
  startTime  String   // HH:MM format
  endTime    String   // HH:MM format
  isActive   Boolean  @default(true)

  @@index([resourceId])
  @@map("resource_availability")
}

model EmailLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  type      String   // verification, password_reset, payment_reminder, payment_success, subscription_activated, etc.
  recipient String
  subject   String
  status    String   // sent, failed, bounced
  error     String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([recipient])
  @@map("email_logs")
}
